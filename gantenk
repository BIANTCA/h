-- Rayfield
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
 Name = "Controls",
 LoadingTitle = "PalaBapakKauLah",
 LoadingSubtitle = "by GANTJENK",
 ConfigurationSaving = {
  Enabled = true,
  FolderName = "CharacterConfig",
  FileName = "CharacterSettings"
 }
})

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local player = Players.LocalPlayer
local mouse = player:GetMouse()

-- Tabs
local CharTab = Window:CreateTab("Character", 4483362458)
local WaypointTab = Window:CreateTab("Waypoint", 4483362458)
local ToolsTab = Window:CreateTab("Tools", 4483362458)

local noclipConn
local flySpeed = 100
local flying = false
local cFlying = false
local flyBV, flyBG, flyConn
local cflyConn
local brightLoop
local highlightActive = false
local highlightObjects = {}
local antiAFKConn
local wsLoop, jpLoop
local antiHooked = false
local oldNamecall
local bringTool

-- =========================
-- CHARACTER
-- =========================
CharTab:CreateSection("Character Main")

local UserInputService = game:GetService("UserInputService")
local infJumpConn
local godConn

local function startGodLoop()
 local function apply(char)
  local hum = char and char:FindFirstChildWhichIsA("Humanoid")
  if not hum then return end
  hum.MaxHealth = math.huge
  hum.Health = hum.MaxHealth
  if godConn then godConn:Disconnect() end
  godConn = hum:GetPropertyChangedSignal("Health"):Connect(function()
   if hum.Health < hum.MaxHealth then
    hum.Health = hum.MaxHealth
   end
  end)
 end

 apply(player.Character)
 player.CharacterAdded:Connect(function(c)
  task.wait(0.1)
  apply(c)
 end)
end

local function stopGodLoop()
 if godConn then godConn:Disconnect() godConn=nil end
 local char = player.Character
 local hum = char and char:FindFirstChildWhichIsA("Humanoid")
 if hum then
  hum.MaxHealth = 100
  hum.Health = hum.MaxHealth
 end
end

local function startInfiniteJump()
 infJumpConn = UserInputService.JumpRequest:Connect(function()
  local char = player.Character
  local hum = char and char:FindFirstChildWhichIsA("Humanoid")
  if hum then
   hum:ChangeState(Enum.HumanoidStateType.Jumping)
  end
 end)
end

local function stopInfiniteJump()
 if infJumpConn then infJumpConn:Disconnect() infJumpConn=nil end
end

local function startNoclip()
 noclipConn = RunService.Stepped:Connect(function()
  local char = player.Character
  if char then
   for _,p in pairs(char:GetDescendants()) do
    if p:IsA("BasePart") then p.CanCollide = false end
   end
  end
 end)
end

local function stopNoclip()
 if noclipConn then noclipConn:Disconnect() noclipConn=nil end
end

CharTab:CreateToggle({
 Name = "Infinite Jump",
 CurrentValue = false,
 Callback = function(v)
  if v then startInfiniteJump() else stopInfiniteJump() end
 end
})

CharTab:CreateToggle({
 Name = "Noclip",
 CurrentValue = false,
 Callback = function(v)
  if v then startNoclip() else stopNoclip() end
 end
})

CharTab:CreateToggle({
 Name = "God Mode",
 CurrentValue = false,
 Callback = function(v)
  if v then startGodLoop() else stopGodLoop() end
 end
})
-- =========================
-- SPEED & JUMP
-- =========================
CharTab:CreateSection("Movement")

CharTab:CreateSlider({
 Name = "WalkSpeed",
 Range = {16,300},
 Increment = 5,
 CurrentValue = 16,
 Callback = function(v)
  local char = player.Character
  local hum = char and char:FindFirstChildWhichIsA("Humanoid")
  if hum then
   hum.WalkSpeed = v
   if wsLoop then wsLoop:Disconnect() end
   wsLoop = hum:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
    hum.WalkSpeed = v
   end)
  end
 end
})

CharTab:CreateSlider({
 Name = "JumpPower",
 Range = {50,300},
 Increment = 10,
 CurrentValue = 50,
 Callback = function(v)
  local char = player.Character
  local hum = char and char:FindFirstChildWhichIsA("Humanoid")
  if hum then
   hum.JumpPower = v
   if jpLoop then jpLoop:Disconnect() end
   jpLoop = hum:GetPropertyChangedSignal("JumpPower"):Connect(function()
    hum.JumpPower = v
   end)
  end
 end
})

-- =========================
-- VISUAL
-- =========================
CharTab:CreateSection("Visual")

local function nofog()
 Lighting.FogEnd = 1e5
 for _,o in pairs(Lighting:GetDescendants()) do
  if o:IsA("Atmosphere") then o:Destroy() end
 end
end

local function loopfullbright()
 if brightLoop then brightLoop:Disconnect() end
 brightLoop = RunService.RenderStepped:Connect(function()
  Lighting.Brightness = 2
  Lighting.ClockTime = 14
  Lighting.FogEnd = 1e5
  Lighting.GlobalShadows = false
  Lighting.OutdoorAmbient = Color3.fromRGB(128,128,128)
 end)
end

local function unloopfullbright()
 if brightLoop then brightLoop:Disconnect() brightLoop=nil end
end

CharTab:CreateButton({ Name = "No Fog", Callback = nofog })

CharTab:CreateToggle({
 Name = "Fullbright",
 CurrentValue = false,
 Callback = function(v)
  if v then loopfullbright() else unloopfullbright() end
 end
})

-- HIGHLIGHT
local function clearHighlights()
 for _,h in pairs(highlightObjects) do
  if h then h:Destroy() end
 end
 highlightObjects = {}
end

local function getTeamColor(plr)
 if not plr.Team or not player.Team then
  return Color3.fromRGB(255,255,255)
 end

 if plr.Team == player.Team then
  return Color3.fromRGB(0,170,255) -- teammate
 else
  return Color3.fromRGB(255,60,60) -- enemy
 end
end

RunService.RenderStepped:Connect(function()
 if not highlightActive then
  clearHighlights()
  return
 end

 for _,plr in pairs(Players:GetPlayers()) do
  if plr ~= player and plr.Character then
   local h = highlightObjects[plr]

   if not h then
    h = Instance.new("Highlight")
    h.FillTransparency = 0.25
    h.OutlineTransparency = 0
    h.Parent = plr.Character
    highlightObjects[plr] = h
   end

   local col = getTeamColor(plr)
   h.FillColor = col
   h.OutlineColor = col
  end
 end
end)

CharTab:CreateToggle({
 Name = "Highlight",
 CurrentValue = false,
 Callback = function(v)
  highlightActive = v
  if not v then clearHighlights() end
 end
})

-- =========================
-- FLY
-- =========================
CharTab:CreateSection("Fly")

CharTab:CreateSlider({
 Name = "Fly Speed",
 Range = {20,300},
 Increment = 10,
 CurrentValue = flySpeed,
 Callback = function(v)
  flySpeed = v
 end
})

local function stopFly()
 if flyConn then flyConn:Disconnect() flyConn=nil end
 if flyBV then flyBV:Destroy() flyBV=nil end
 if flyBG then flyBG:Destroy() flyBG=nil end
 local char = player.Character
 if char then
  local hum = char:FindFirstChildWhichIsA("Humanoid")
  if hum then hum.PlatformStand = false end
 end
 flying = false
end

CharTab:CreateToggle({
 Name = "Fly (Mobile)",
 CurrentValue = false,
 Callback = function(v)
  if v then
   if cflyConn then cflyConn:Disconnect() cflyConn=nil end
   local char = player.Character or player.CharacterAdded:Wait()
   local root = char:WaitForChild("HumanoidRootPart")
   local hum = char:FindFirstChildWhichIsA("Humanoid")
   hum.PlatformStand = true

   flyBV = Instance.new("BodyVelocity")
   flyBV.MaxForce = Vector3.new(9e9,9e9,9e9)
   flyBV.Parent = root

   flyBG = Instance.new("BodyGyro")
   flyBG.MaxTorque = Vector3.new(9e9,9e9,9e9)
   flyBG.P = 1000
   flyBG.D = 50
   flyBG.Parent = root

   local control = require(player.PlayerScripts.PlayerModule.ControlModule)

   flyConn = RunService.RenderStepped:Connect(function()
    local cam = workspace.CurrentCamera
    local move = control:GetMoveVector()
    flyBG.CFrame = cam.CFrame
    flyBV.Velocity = Vector3.new()
    if move.Magnitude > 0 then
     flyBV.Velocity =
      (cam.CFrame.LookVector * -move.Z + cam.CFrame.RightVector * move.X)
      * flySpeed
    end
   end)
   flying = true
  else
   stopFly()
  end
 end
})

-- CFly sesuai versi yang kamu beri
CharTab:CreateToggle({
 Name = "CFly",
 CurrentValue = false,
 Callback = function(v)
  if v then
   stopFly()
   local char = player.Character or player.CharacterAdded:Wait()
   local hum = char:FindFirstChildWhichIsA("Humanoid")
   local head = char:WaitForChild("Head")
   hum.PlatformStand = true
   head.Anchored = true

   cflyConn = RunService.Heartbeat:Connect(function(dt)
    local move = hum.MoveDirection * (flySpeed * dt)
    local cam = workspace.CurrentCamera
    local hc = head.CFrame
    local cc = cam.CFrame
    local off = hc:ToObjectSpace(cc).Position
    cc = cc * CFrame.new(-off.X, -off.Y, -off.Z + 1)
    local cp, hp = cc.Position, hc.Position
    local obj = CFrame.new(cp, Vector3.new(hp.X, cp.Y, hp.Z)):VectorToObjectSpace(move)
    head.CFrame = CFrame.new(hp) * (cc - cp) * CFrame.new(obj)
   end)
   cFlying = true
  else
   if cflyConn then cflyConn:Disconnect() cflyConn=nil end
   local char = player.Character
   if char then
    local hum = char:FindFirstChildWhichIsA("Humanoid")
    local head = char:FindFirstChild("Head")
    if hum then hum.PlatformStand = false end
    if head then head.Anchored = false end
   end
   cFlying = false
  end
 end
})

-- =========================
-- WAYPOINT
-- =========================
local waypoints = {}

WaypointTab:CreateButton({
 Name = "Save Waypoint",
 Callback = function()
  local char = player.Character
  local root = char and char:FindFirstChild("HumanoidRootPart")
  if root then table.insert(waypoints, root.CFrame) end
 end
})

WaypointTab:CreateButton({
 Name = "Teleport Last Waypoint",
 Callback = function()
  local wp = waypoints[#waypoints]
  local char = player.Character
  local root = char and char:FindFirstChild("HumanoidRootPart")
  if wp and root then root.CFrame = wp + Vector3.new(0,3,0) end
 end
})

-- =========================
-- TOOLS
-- =========================
ToolsTab:CreateButton({
 Name = "Teleport Tool",
 Callback = function()
  local tpTool = Instance.new("Tool")
  tpTool.Name = "Teleport Tool"
  tpTool.RequiresHandle = false
  tpTool.Parent = player.Backpack

  tpTool.Activated:Connect(function()
   local char = player.Character
   local root = char and char:FindFirstChild("HumanoidRootPart")
   if root and mouse.Hit then
    root.CFrame = CFrame.new(mouse.Hit.Position + Vector3.new(0,3,0))
   end
  end)
 end
})

local deleteTool

ToolsTab:CreateToggle({
 Name = "Delete Tool",
 CurrentValue = false,
 Callback = function(v)
  if v then
   if deleteTool then return end
   deleteTool = Instance.new("Tool")
   deleteTool.Name = "Delete Tool"
   deleteTool.RequiresHandle = false
   deleteTool.Parent = player.Backpack

   deleteTool.Activated:Connect(function()
    local target = mouse.Target
    if target and not target:IsDescendantOf(player.Character) then
     target:Destroy()
    end
   end)
  else
   if deleteTool then
    deleteTool:Destroy()
    deleteTool = nil
   end
  end
 end
})

ToolsTab:CreateToggle({
 Name = "Bring Tool",
 CurrentValue = false,
 Callback = function(v)
  if v then
   if bringTool then return end

   bringTool = Instance.new("Tool")
   bringTool.Name = "Bring Tool"
   bringTool.RequiresHandle = false
   bringTool.Parent = player.Backpack

   bringTool.Activated:Connect(function()
    local char = player.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    local target = mouse.Target

    if root and target and target:IsA("BasePart") and not target:IsDescendantOf(char) then
     target.CFrame = root.CFrame * CFrame.new(0, 0, -5)
    end
   end)
  else
   if bringTool then
    bringTool:Destroy()
    bringTool = nil
   end
  end
 end
})

ToolsTab:CreateToggle({
 Name = "Anti AFK",
 CurrentValue = false,
 Callback = function(v)
  if v then
   local GC = getconnections or get_signal_cons

   if GC then
    for _,c in pairs(GC(player.Idled)) do
     if c.Disable then
      c:Disable()
     elseif c.Disconnect then
      c:Disconnect()
     end
    end
   else
    local VirtualUser = cloneref(game:GetService("VirtualUser"))
    antiAFKConn = player.Idled:Connect(function()
     VirtualUser:CaptureController()
     VirtualUser:ClickButton2(Vector2.new())
    end)
   end

  else
   if antiAFKConn then
    antiAFKConn:Disconnect()
    antiAFKConn = nil
   end
  end
 end
})

ToolsTab:CreateToggle({
 Name = "Anti Kick / Ban",
 CurrentValue = false,
 Callback = function(v)
  if v and not antiHooked then
   antiHooked = true

   oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    if method == "Kick" then
     return
    end
    if method == "FireServer" or method == "InvokeServer" then
     local n = tostring(self):lower()
     if n:find("ban") or n:find("kick") then
      return
     end
    end
    return oldNamecall(self, ...)
   end)

  elseif not v and antiHooked then
   antiHooked = false
  end
 end
})

-- =========================
-- SETTINGS / UTIL
-- =========================

ToolsTab:CreateButton({
 Name = "Rejoin Server",
 Callback = function()
  local TeleportService = game:GetService("TeleportService")
  TeleportService:Teleport(game.PlaceId, player)
 end
})

ToolsTab:CreateButton({
 Name = "Close & Destroy GUI",
 Callback = function()
  if Window then
   Window:Destroy()
  end
 end
})
