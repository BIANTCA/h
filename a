--[[
CoolController v8 - HybridFly + Waypoint List
Tanpa input bawah, waypoint tersimpan otomatis dan muncul di daftar klik.
]]

local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local mouse = player:GetMouse()

-- Hapus GUI lama
if player.PlayerGui:FindFirstChild("CoolController") then
 player.PlayerGui.CoolController:Destroy()
end

-- GUI utama
local gui = Instance.new("ScreenGui")
gui.Name = "CoolController"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 360, 0, 320)
frame.Position = UDim2.new(0.5, -180, 0.5, -160)
frame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
frame.BorderSizePixel = 0
frame.Visible = false
frame.Active = true
frame.Draggable = true
frame.Parent = gui

Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)
local stroke = Instance.new("UIStroke", frame)
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(100, 100, 100)

-- Judul
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 35)
title.Text = "Cool Controller"
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(230, 230, 230)
title.Parent = frame

-- Tombol Toggle GUI
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 32, 0, 32)
toggleButton.Position = UDim2.new(0, 20, 0.5, -16)
toggleButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
toggleButton.Text = "Open"
toggleButton.TextSize = 14
toggleButton.TextColor3 = Color3.fromRGB(200, 200, 200)
toggleButton.Parent = gui
Instance.new("UICorner", toggleButton).CornerRadius = UDim.new(0, 6)

-- Toggle drag
local dragging, dragStart, startPos, dragInput = false, nil, nil, nil
local function updatePos(input)
 local delta = input.Position - dragStart
 toggleButton.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
  startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
toggleButton.InputBegan:Connect(function(input)
 if input.UserInputType == Enum.UserInputType.MouseButton1 then
  dragging = true
  dragStart = input.Position
  startPos = toggleButton.Position
  input.Changed:Connect(function()
   if input.UserInputState == Enum.UserInputState.End then dragging = false end
  end)
 end
end)
toggleButton.InputChanged:Connect(function(input)
 if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
end)
UserInputService.InputChanged:Connect(function(input)
 if input == dragInput and dragging then updatePos(input) end
end)

local function toggleGUI()
 frame.Visible = not frame.Visible
 toggleButton.Text = frame.Visible and "Close" or "Open"
 toggleButton.BackgroundColor3 = frame.Visible and Color3.fromRGB(120, 0, 0) or Color3.fromRGB(70, 70, 70)
end
toggleButton.MouseButton1Click:Connect(toggleGUI)
UserInputService.InputBegan:Connect(function(i,gp)
 if not gp and i.KeyCode == Enum.KeyCode.RightControl then toggleGUI() end
end)

------------------------------------------------
-- GRID (2 kolom)
------------------------------------------------
local btnHolder = Instance.new("Frame")
btnHolder.Size = UDim2.new(1, -20, 0, 150)
btnHolder.Position = UDim2.new(0, 10, 0, 40)
btnHolder.BackgroundTransparency = 1
btnHolder.Parent = frame

local grid = Instance.new("UIGridLayout", btnHolder)
grid.CellSize = UDim2.new(0, 150, 0, 32)
grid.CellPadding = UDim2.new(0, 10, 0, 10)
grid.FillDirectionMaxCells = 2
grid.HorizontalAlignment = Enum.HorizontalAlignment.Center
grid.VerticalAlignment = Enum.VerticalAlignment.Top

local function newButton(name, text)
 local b = Instance.new("TextButton")
 b.Name = name
 b.Text = text
 b.Font = Enum.Font.GothamSemibold
 b.TextSize = 14
 b.TextColor3 = Color3.new(1,1,1)
 b.BackgroundColor3 = Color3.fromRGB(80,80,80)
 Instance.new("UICorner", b).CornerRadius = UDim.new(0,6)
 b.Parent = btnHolder
 return b
end

------------------------------------------------
-- FITUR UTAMA
------------------------------------------------
local highlightActive, fullbrightActive, flyActive, noclipActive = false, false, false, false
local brightLoop, CFloop, noclipConn = nil, nil, nil
local highlightObjects = {}
local CFspeed = 100
local Head

-- Highlight
local function clearHighlights()
 for _,h in pairs(highlightObjects) do if h then h:Destroy() end end
 highlightObjects = {}
end
local function updateHighlights()
 if not highlightActive then clearHighlights() return end
 for _,plr in pairs(Players:GetPlayers()) do
  if plr ~= player and plr.Character and not highlightObjects[plr] then
   local h = Instance.new("Highlight")
   h.FillColor = Color3.fromRGB(255,50,50)
   h.OutlineColor = Color3.fromRGB(100,0,0)
   h.FillTransparency = 0.3
   h.Parent = plr.Character
   highlightObjects[plr] = h
  end
 end
end
RunService.RenderStepped:Connect(function()
 if highlightActive then updateHighlights() end
end)

-- Fullbright
local function nofog()
 local L = game:GetService("Lighting")
 L.FogEnd = 1e5
 for _,o in pairs(L:GetDescendants()) do
  if o:IsA("Atmosphere") then o:Destroy() end
 end
end
local function loopfullbright()
 local L = game:GetService("Lighting")
 if brightLoop then brightLoop:Disconnect() end
 local function upd()
  L.Brightness = 2
  L.ClockTime = 14
  L.FogEnd = 1e5
  L.GlobalShadows = false
  L.OutdoorAmbient = Color3.fromRGB(128,128,128)
 end
 brightLoop = RunService.RenderStepped:Connect(upd)
 upd()
end
local function unloopfullbright() if brightLoop then brightLoop:Disconnect() brightLoop=nil end end

------------------------------------------------
-- MOBILE FLY (versi baru, hybrid-friendly)
------------------------------------------------
local CMD_Settings = {
 FlyCMD = {
  FlyOn = false,
  FlySpeed = 2
 }
}

local mfly1, mfly2

function UnMobileFly()
 CMD_Settings.FlyCMD.FlyOn = false
 local char = player.Character
 if not char then return end
 local root = char:FindFirstChild("HumanoidRootPart")
 if not root then return end

 if root:FindFirstChild("BodyVelocity") then
  root.BodyVelocity:Destroy()
 end
 if root:FindFirstChild("BodyGyro") then
  root.BodyGyro:Destroy()
 end

 local humanoid = char:FindFirstChildOfClass("Humanoid")
 if humanoid then
  humanoid.PlatformStand = false
 end

 if mfly1 then mfly1:Disconnect() mfly1 = nil end
 if mfly2 then mfly2:Disconnect() mfly2 = nil end
end

function MobileFly()
 UnMobileFly()
 CMD_Settings.FlyCMD.FlyOn = true

 local root = player.Character:WaitForChild("HumanoidRootPart")
 local camera = workspace.CurrentCamera
 local v3none = Vector3.new()
 local v3zero = Vector3.new(0, 0, 0)
 local v3inf = Vector3.new(9e9, 9e9, 9e9)

 local controlModule = require(player.PlayerScripts:WaitForChild("PlayerModule"):WaitForChild("ControlModule"))
 local bv = Instance.new("BodyVelocity")
 bv.Name = "BodyVelocity"
 bv.Parent = root
 bv.MaxForce = v3zero
 bv.Velocity = v3zero

 local bg = Instance.new("BodyGyro")
 bg.Name = "BodyGyro"
 bg.Parent = root
 bg.MaxTorque = v3inf
 bg.P = 1000
 bg.D = 50

 mfly1 = player.CharacterAdded:Connect(function()
  local newRoot = player.Character:WaitForChild("HumanoidRootPart")
  local newBv = Instance.new("BodyVelocity")
  newBv.Name = "BodyVelocity"
  newBv.Parent = newRoot
  newBv.MaxForce = v3zero
  newBv.Velocity = v3zero

  local newBg = Instance.new("BodyGyro")
  newBg.Name = "BodyGyro"
  newBg.Parent = newRoot
  newBg.MaxTorque = v3inf
  newBg.P = 1000
  newBg.D = 50
 end)

 mfly2 = RunService.RenderStepped:Connect(function()
  root = player.Character:WaitForChild("HumanoidRootPart")
  camera = workspace.CurrentCamera
  if player.Character:FindFirstChildWhichIsA("Humanoid") and root:FindFirstChild("BodyVelocity") and root:FindFirstChild("BodyGyro") then
   local humanoid = player.Character:FindFirstChildWhichIsA("Humanoid")
   local VelocityHandler = root:FindFirstChild("BodyVelocity")
   local GyroHandler = root:FindFirstChild("BodyGyro")

   VelocityHandler.MaxForce = v3inf
   GyroHandler.MaxTorque = v3inf
   humanoid.PlatformStand = true
   GyroHandler.CFrame = camera.CFrame
   VelocityHandler.Velocity = v3none

   local direction = controlModule:GetMoveVector()
   if direction.Magnitude > 0 then
    VelocityHandler.Velocity =
     (camera.CFrame.LookVector * -direction.Z + camera.CFrame.RightVector * direction.X)
     * (CMD_Settings.FlyCMD.FlySpeed * 50)
   end
  end
 end)
end

------------------------------------------------
-- NOCLIP
------------------------------------------------
local function startNoclip()
 noclipActive = true
 noclipConn = RunService.Stepped:Connect(function()
  if player.Character then
   for _,p in pairs(player.Character:GetDescendants()) do
    if p:IsA("BasePart") then p.CanCollide=false end
   end
  end
 end)
end
local function stopNoclip()
 noclipActive = false
 if noclipConn then noclipConn:Disconnect() noclipConn=nil end
end

------------------------------------------------
-- WAYPOINT LIST SYSTEM
------------------------------------------------
local waypoints = {}
local wpFrame = Instance.new("ScrollingFrame")
wpFrame.Size = UDim2.new(1, -20, 0, 90)
wpFrame.Position = UDim2.new(0, 10, 1, -150)
wpFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
wpFrame.BorderSizePixel = 0
wpFrame.ScrollBarThickness = 6
wpFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
wpFrame.Parent = frame
Instance.new("UICorner", wpFrame).CornerRadius = UDim.new(0, 8)

local listLayout = Instance.new("UIListLayout", wpFrame)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Padding = UDim.new(0, 5)

local function refreshWPList()
 for _,child in pairs(wpFrame:GetChildren()) do
  if child:IsA("TextButton") then child:Destroy() end
 end
 for i,wp in ipairs(waypoints) do
  local btn = Instance.new("TextButton")
  btn.Size = UDim2.new(1, -5, 0, 26)
  btn.Text = wp.name
  btn.Font = Enum.Font.GothamSemibold
  btn.TextSize = 14
  btn.TextColor3 = Color3.new(1,1,1)
  btn.BackgroundColor3 = Color3.fromRGB(70,70,70)
  Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)
  btn.Parent = wpFrame
  btn.MouseButton1Click:Connect(function()
   local char = player.Character
   local root = char and char:FindFirstChild("HumanoidRootPart")
   if root then root.CFrame = CFrame.new(wp.pos + Vector3.new(0,3,0)) end
  end)
 end
 wpFrame.CanvasSize = UDim2.new(0, 0, 0, #waypoints * 32)
end

local function saveWaypoint()
 local char = player.Character
 local root = char and char:FindFirstChild("HumanoidRootPart")
 if root then
  local name = "WP" .. tostring(#waypoints + 1)
  table.insert(waypoints, {name = name, pos = root.Position})
  refreshWPList()
 end
end

------------------------------------------------
-- TOMBOL UTAMA
------------------------------------------------
local btnHighlight = newButton("Highlight","Highlight: OFF")
btnHighlight.MouseButton1Click:Connect(function()
 highlightActive = not highlightActive
 btnHighlight.Text = highlightActive and "Highlight: ON" or "Highlight: OFF"
 btnHighlight.BackgroundColor3 = highlightActive and Color3.fromRGB(150,0,0) or Color3.fromRGB(80,80,80)
 updateHighlights()
end)

local btnBright = newButton("Fullbright","Fullbright: OFF")
btnBright.MouseButton1Click:Connect(function()
 fullbrightActive = not fullbrightActive
 if fullbrightActive then nofog(); loopfullbright() else unloopfullbright() end
 btnBright.Text = fullbrightActive and "Fullbright: ON" or "Fullbright: OFF"
 btnBright.BackgroundColor3 = fullbrightActive and Color3.fromRGB(150,0,0) or Color3.fromRGB(80,80,80)
end)

local btnFly = newButton("MobileFly","Fly: OFF")
btnFly.MouseButton1Click:Connect(function()
 flyActive = not flyActive
 if flyActive then
  MobileFly()
  btnFly.Text = "Fly: ON"
  btnFly.BackgroundColor3 = Color3.fromRGB(150,0,0)
 else
  UnMobileFly()
  btnFly.Text = "Fly: OFF"
  btnFly.BackgroundColor3 = Color3.fromRGB(80,80,80)
 end
end)

local btnNoclip = newButton("Noclip","Noclip: OFF")
btnNoclip.MouseButton1Click:Connect(function()
 noclipActive = not noclipActive
 if noclipActive then startNoclip() else stopNoclip() end
 btnNoclip.Text = noclipActive and "Noclip: ON" or "Noclip: OFF"
 btnNoclip.BackgroundColor3 = noclipActive and Color3.fromRGB(150,0,0) or Color3.fromRGB(80,80,80)
end)

local btnSaveWP = newButton("SaveWP","Save Waypoint")
btnSaveWP.MouseButton1Click:Connect(saveWaypoint)

local btnDestroy = newButton("Destroy","Destroy GUI")
btnDestroy.BackgroundColor3 = Color3.fromRGB(150,0,0)
btnDestroy.MouseButton1Click:Connect(function() gui:Destroy() end)
