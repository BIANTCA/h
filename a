local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local player = Players.LocalPlayer

-- STATE VARIABLES
local guiEnabled = false
local brightLoop
local highlightActive = false
local nofogActive = false
local highlightObjects = {}

-- Remove old GUI if re-running
if player.PlayerGui:FindFirstChild("MainMenuGUI") then
    player.PlayerGui.MainMenuGUI:Destroy()
end

-- Create GUI
local gui = Instance.new("ScreenGui")
gui.Name = "MainMenuGUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

-- Main frame (initially hidden)
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 300, 0, 320)
frame.Position = UDim2.new(0, 25, 0.5, -160)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Visible = false
frame.Parent = gui

Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 40)
title.BackgroundTransparency = 1
title.Text = "Menu Utama"
title.Font = Enum.Font.GothamMedium
title.TextColor3 = Color3.fromRGB(220, 220, 220)
title.TextSize = 18
title.Parent = frame

-- Close button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -35, 0, 5)
closeBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
closeBtn.Text = "✕"
closeBtn.TextColor3 = Color3.white
closeBtn.TextSize = 18
closeBtn.BorderSizePixel = 0
closeBtn.AutoButtonColor = false
closeBtn.Parent = frame

Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 6)

-- Button container
local buttonContainer = Instance.new("ScrollingFrame")
buttonContainer.Size = UDim2.new(1, -20, 1, -60)
buttonContainer.Position = UDim2.new(0, 10, 0, 50)
buttonContainer.BackgroundTransparency = 1
buttonContainer.BorderSizePixel = 0
buttonContainer.ScrollBarThickness = 6
buttonContainer.ScrollBarImageColor3 = Color3.fromRGB(70, 70, 75)
buttonContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
buttonContainer.Parent = frame

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0, 8)
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Parent = buttonContainer

-- Toggle button (25px dari kiri, di tengah vertikal)
local toggleButton = Instance.new("TextButton")
toggleButton.Name = "ToggleButton"
toggleButton.Size = UDim2.new(0, 40, 0, 40)
toggleButton.Position = UDim2.new(0, 25, 0.5, -20)
toggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
toggleButton.Text = "⚙"
toggleButton.TextColor3 = Color3.fromRGB(220, 220, 220)
toggleButton.TextSize = 20
toggleButton.ZIndex = 100
toggleButton.BorderSizePixel = 0
toggleButton.AutoButtonColor = false
toggleButton.Parent = gui

Instance.new("UICorner", toggleButton).CornerRadius = UDim.new(0, 8)

-- FUNCTION: Create toggle button
local function createToggleButton(text, initialState)
    local button = Instance.new("TextButton")
    button.Text = text .. ": " .. (initialState and "ON" or "OFF")
    button.Size = UDim2.new(1, 0, 0, 40)
    button.BackgroundColor3 = initialState and Color3.fromRGB(60, 120, 60) or Color3.fromRGB(70, 70, 75)
    button.TextColor3 = Color3.white
    button.TextSize = 14
    button.Font = Enum.Font.Gotham
    button.AutoButtonColor = false
    button.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    button.MouseEnter:Connect(function()
        button.BackgroundColor3 = initialState and Color3.fromRGB(70, 140, 70) or Color3.fromRGB(85, 85, 90)
    end)
    
    button.MouseLeave:Connect(function()
        button.BackgroundColor3 = initialState and Color3.fromRGB(60, 120, 60) or Color3.fromRGB(70, 70, 75)
    end)
    
    button.MouseButton1Down:Connect(function()
        button.BackgroundColor3 = initialState and Color3.fromRGB(50, 100, 50) or Color3.fromRGB(60, 60, 65)
    end)
    
    button.MouseButton1Up:Connect(function()
        button.BackgroundColor3 = initialState and Color3.fromRGB(60, 120, 60) or Color3.fromRGB(70, 70, 75)
    end)
    
    return button
end

-- FUNCTION: Fullbright toggle
local function toggleFullbright()
    if brightLoop then
        brightLoop:Disconnect()
        brightLoop = nil
        return false
    else
        local function updateLighting()
            Lighting.Brightness = 2
            Lighting.ClockTime = 14
            Lighting.FogEnd = 100000
            Lighting.GlobalShadows = false
            Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
        end
        
        brightLoop = RunService.RenderStepped:Connect(updateLighting)
        updateLighting()
        return true
    end
end

-- FUNCTION: Highlight toggle
local function toggleHighlight()
    highlightActive = not highlightActive
    
    if highlightActive then
        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= player and plr.Character and not highlightObjects[plr] then
                local highlight = Instance.new("Highlight")
                highlight.FillColor = Color3.fromRGB(255, 255, 255)
                highlight.OutlineColor = Color3.fromRGB(50, 50, 50)
                highlight.FillTransparency = 0.7
                highlight.Parent = plr.Character
                highlightObjects[plr] = highlight
            end
        end
    else
        for plr, highlight in pairs(highlightObjects) do
            if highlight then 
                highlight:Destroy() 
            end
        end
        highlightObjects = {}
    end
    
    return highlightActive
end

-- FUNCTION: Nofog toggle
local function toggleNofog()
    nofogActive = not nofogActive
    
    if nofogActive then
        Lighting.FogEnd = 100000
        for _, obj in pairs(Lighting:GetDescendants()) do
            if obj:IsA("Atmosphere") then
                obj:Destroy()
            end
        end
    else
        Lighting.FogEnd = 10000
    end
    
    return nofogActive
end

-- Setup buttons in menu
local function setupMenuButtons()
    buttonContainer:ClearAllChildren()
    
    -- Fullbright button
    local fullbrightBtn = createToggleButton("Fullbright", brightLoop ~= nil)
    fullbrightBtn.LayoutOrder = 1
    fullbrightBtn.Parent = buttonContainer
    
    fullbrightBtn.MouseButton1Click:Connect(function()
        local enabled = toggleFullbright()
        fullbrightBtn.Text = "Fullbright: " .. (enabled and "ON" or "OFF")
        fullbrightBtn.BackgroundColor3 = enabled and Color3.fromRGB(60, 120, 60) or Color3.fromRGB(70, 70, 75)
    end)
    
    -- Highlight button
    local highlightBtn = createToggleButton("Highlight", highlightActive)
    highlightBtn.LayoutOrder = 2
    highlightBtn.Parent = buttonContainer
    
    highlightBtn.MouseButton1Click:Connect(function()
        local enabled = toggleHighlight()
        highlightBtn.Text = "Highlight: " .. (enabled and "ON" or "OFF")
        highlightBtn.BackgroundColor3 = enabled and Color3.fromRGB(60, 120, 60) or Color3.fromRGB(70, 70, 75)
    end)
    
    -- Nofog button
    local nofogBtn = createToggleButton("Nofog", nofogActive)
    nofogBtn.LayoutOrder = 3
    nofogBtn.Parent = buttonContainer
    
    nofogBtn.MouseButton1Click:Connect(function()
        local enabled = toggleNofog()
        nofogBtn.Text = "Nofog: " .. (enabled and "ON" or "OFF")
        nofogBtn.BackgroundColor3 = enabled and Color3.fromRGB(60, 120, 60) or Color3.fromRGB(70, 70, 75)
    end)
    
    -- Update canvas size
    buttonContainer.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
end

-- Toggle GUI function
local function toggleGUI()
    guiEnabled = not guiEnabled
    frame.Visible = guiEnabled
    
    if guiEnabled then
        toggleButton.Text = "✕"
        toggleButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
        toggleButton.TextColor3 = Color3.new(1, 1, 1)
        setupMenuButtons()
    else
        toggleButton.Text = "⚙"
        toggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
        toggleButton.TextColor3 = Color3.fromRGB(220, 220, 220)
    end
end

-- Connect buttons
toggleButton.MouseButton1Click:Connect(toggleGUI)
closeBtn.MouseButton1Click:Connect(function()
    guiEnabled = false
    frame.Visible = false
    toggleButton.Text = "⚙"
    toggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    toggleButton.TextColor3 = Color3.fromRGB(220, 220, 220)
end)

-- Keybind toggle (RightControl)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.RightControl then
        toggleGUI()
    end
end)

-- Auto-start features
task.wait(1)
toggleFullbright()
toggleNofog()
